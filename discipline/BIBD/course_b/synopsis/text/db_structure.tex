\section[Разработка структуры БД]{РАЗРАБОТКА СТРУКТУРЫ БАЗЫ ДАННЫХ}
\label{sub:db_structure}

\subsection{Цели проектирования базы данных}
\label{ssub:db_structure_aims}

\textit{База данных} --- некоторый набор постоянно хранимых данных,
используемых прикладными программными системами какого-либо предприятия.

\textit{Задача проектирования базы данных} (БД) в целом формулируется
следующим образом: выбрать подходящую логическую структуру для заданного
массива данных, которые требуется поместить в базу данных~\cite{date05}.

Ниже перечислены основные цели проектирования баз данных:
\begin{itemize}
\item
  обеспечение хранения в базе даннх всех необходимых данных;
\item
  обеспечение получения данных по всем необходимым запросам;
\item
  сокращение избыточности и дублирования данных;
\item
  обеспечение целостности данных: исключение потери данных, противоречий в
  содержании базы данных, нарушений смысла данных;
\item
  сокращение времени обработки запросов к данным.
\end{itemize}

\subsection{Этапы проектирования базы данных}
\label{ssub:db_structure_stages}

Процесс проектирования баз данных можно разделить на три основных этапа:
\begin{itemize}
\item инфологическое проектирование;
\item даталогическое проектирование;
\item физическое проектирование.
\end{itemize}

Рассмотрим каждый из этих этапов более подробно.

\textit{Инфологическое проектирование} --- анализ
предметной области и ее описание. Этот этап осуществляется без ориентации
на какие-либо конкретные программные или технические средства реализации.
Результатом инфологического проектирования является
\textit{инфологическая модель} --- формализованная модель предметной области,
построенная с использованием специальных языковых средств (обычно графических).

Инфологическая модель включает следующие основные элементы:
\begin{itemize}
\item
  описание объектов предметной области;
\item
  описание свойств объектов;
\item
  описание связей между объектами.
\end{itemize}

Для описания объектов предметной области, их свойств и связей между
ними обычно применяются стандартизированные системы графических обозначений.
Кроме того, инфологическая модель может включать
описание основных запросов к проектируемой БД,
описание документов, используемых в качестве
источников данных для БД или составляемых на основе БД,
описание алгоритмических связей между данными,
описание ограничений целостности, т.е. правил, обеспечивающих
актуальность и непротиворечивость данных.

\textit{Даталогическое проектирование} --- описание
логической структуры данных средствами системы управления базами данных
(СУБД), для которой проектируется БД.
Такое описание (\textit{даталогическая модель}) строится на основе инфологической модели
по определенным правилам.
Для реляционных БД даталогическая модель состоит из следующих частей:
\begin{itemize}
\item
  описания таблиц;
\item
  описания связей между таблицами;
\item
  описания атрибутов.
\end{itemize}

\textit{Физическое проектирование} --- на этом этапе выполняется описание
физической структуры БД, то есть ее размещения на запоминающем устройстве.
Такое описание называется \textit{физической моделью}, которая включает:

\begin{itemize}
\item
  тип носителя;
\item
  способы организации данных;
\item
  способы управления свободной памятью;
\item
  способы сжатия данных и т.д.
\end{itemize}

\subsection{Инфологическое проектирование}
\label{ssub:db_info_stage}

\paragraph{}
Разрабатываемый сервис должен по запросам пользователей выполнять
следующие операции:
\begin{itemize}
\item
  предоставление доступа к хранимой информации: генерация html-страниц с данными
  о запрашиваемых наградах или награжденных лицах;
\item
  расчет и наглядное представление статистических показателей на
  основе хранимых данных;
\item
  предоставление данных о награжденных в машиночитаемом формате 
  загрузки на носитель пользователя. 
\end{itemize}

Кроме этого, администратор сервиса должен иметь возможность загрузки данных в базу данных
из файла машиночитаемого формата, а также возможность редактирования содержимого БД
через графический интерфейс, предоставляемый сервисом.

На рисунке~\ref{fig:use-case_diagram} представлена диаграмма сценариев
использования проектируемого сервиса.

Для построения диаграмм прецендентов и потоков данных был использован бесплатный
программный продукт Dia, распространяемый по свободной лицензии~\cite{dia_license}.

\begin{figure}[h!]
  \centering
  \small{
    \input{pic/use-case.tex}
  }
  \caption{Диаграмма прецендентов \\ использования проектируемого веб-сервиса}
  \label{fig:use-case_diagram}
\end{figure}

\paragraph{}
В качестве источника данных используются файлы в машиночитаемом формате,
которые получаются после разбора соответствующих файлов формата pdf,
предоставленных национальным статистическим комитетом Республики Беларусь.

Файлы-источники данных имеют формат csv или xml c заранее определенным
набором cтолбцов, который не может подвергаться изменениям.
В качестве формата файлов, предоставляемых пользователям для загрузки,
также используются csv либо xml.

На рисунке~\ref{fig:activity_diagram} представлены потоки обработки данных,
имеющих отношение к проектируемому веб-сервису.

\begin{figure}[h!]
  \centering
  \small{
    \input{pic/activity.tex}
  }
  \caption{Диаграмма потоков данных проектируемого веб-сервиса}
  \label{fig:activity_diagram}
\end{figure}

\paragraph{}
Рассмотрим наборы входных данных.
Файл \textit{awards.csv} хранит информацию о наградах и состоит из
следующих полей:
\begin{itemize}
\item
  \textit{award\_title} --- название награды
  (например, медаль <<За адзнаку ў воінскай службе>>);
\item
  \textit{type} --- тип награды
  (медаль);
\item
  \textit{description} --- краткое описание награды
  (медалем <<За адзнаку ў воінскай службе>>
  ўзнагароджваюцца вайскоўцы за значныя заслугі ў воінскай службе);
\end{itemize}

Атрибут \textit{award\_title} является уникальным, поэтому его можно использовать
в качестве идентификатора награды.
Каждому типу type награды может соответствовать несколько названий 
\textit{award\_title} и описаний \textit{description}.
Каждому названию \textit{award\_title} или описанию \textit{description} награды
соответствует единственный тип \textit{type}.
Содержимое полей \textit{description} является необязательным.

Файл \textit{awarded.csv} хранит информацию о награжденных и состоит из следующих полей:
\begin{itemize}
\item
  \textit{fio} --- фамилия, имя, отчество награжденного
  (например, Апрышка Міхаіл Пятровіч);
\item
  \textit{dolzhnost} --- занимаемая должность
  (галоўны інспектар аддзела арганізацыі мытнага кантролю Гомельская мытні);
\item
  \textit{pol} --- пол награжденного (м);
\item
  \textit{zvanie} --- звание;
\item
  \textit{mesto\_raboty} --- место работы;
\item 
  \textit{tip\_nagrady} --- тип награды (медаль);
\item
  \textit{nagrada} --- название награды
  (медаль <<За бездакорную службу>>);
\item
  \textit{osnovanie} --- основание для награждения
  (ўзорнае выкананне службовых абавязкаў);
\item
  \textit{dokument} --- название документа, потдвержающий факт награждения
  (Указ Прэзідэнта Рэспублікі Беларусь);
\item
  \textit{nomer\_dokument} --- номер официального документа
  (571);
\item
  \textit{data\_prinjatija} --- дата вступления в силу документа о награждении;
\item
  \textit{RN} --- регистрационный номер награды (1/13962);
\end{itemize}

В исходном файле могут встречаться записи c совпадающими ФИО,
таким образом, свойство \textit{fio} не может является идентификатором.
Каждому документу (свойства \textit{dokument}, \textit{nomer\_dokument},
\textit{data\_prinjatija})
подтверждающему факт награждения, может соответствовать одна или
несколько наград.
Содержимое полей \textit{pol}, \textit{dolzhnost}, \textit{zvanie}, 
\textit{mesto\_raboty}, \textit{osnovanie}, \textit{RN} может отсутствовать.

\paragraph{}
Формат файла с данными о награжденных, предоставляемого сервисом для загрузки,
совпадает с форматом данных файла \textit{awarded.csv}.

\paragraph{}
Исходя из состава входных данных
можно выделить следующие объекты предметной области:

\begin{itemize}
  \item <<факт награждения>> --- содержит информацию о каждом факте награждения,
    соответствующую входному файлу \textit{awarded.csv};
  \item <<награда>> --- содержит информацию о государственных наградах
    Республики Беларусь, соответсвующую набору данных из файла \textit{awards.csv}.
\end{itemize}

Каждому объекту <<факт награждения>> соответствует единственный
объект <<награда>>.
Каждому объекту <<награда>> может соответствовать несколько объектов
<<факт награждения>>.

В объект <<награда>> был добавлено дополнительное свойство
<<изображение награды>>, значения которого будут представлять
системные пути к изображениям наград.

Проектирование базы данных было выполнено с использованием средства 
автоматизированного проектирования CA ERWin, которое распространяется
бесплатно для некоммерческих целей~\cite{er_win_license}.

На рисунке~\ref{fig:er_naive} приведена ER-модель, описывающая связи между 
введенными в рассмотрение объектами предметной области.

\begin{figure}[h]
  \centering
  \includegraphics[width=130mm]{pic/er_naive.png}
  \caption{Исходная ER-модель \\ проектируемой базы данных}
  \label{fig:er_naive}
\end{figure}

Заметим, что данная модель обладает следующими недостатками:
\begin{itemize}
\item
  \textit{дублирование данных}: данные о каждом документе,
  подтверждающем факт награждения
  многократно дублируются и хранятся столько раз,
  сколько имеется объектов <<факт награждения>>;
\item
  \textit{аномалии удаления}: при удалении объекта <<награда>> удаляются
  все сведения о лицах, которые были ею награждены;
\item
  \textit{аномалии обновления}: при изменении значений <<тип награды>> в объекте
  <<награда>> появляется необходимость изменять все соответствующие вхождения этого свойства в
  объекты <<факт награждения>>.
\end{itemize}

\paragraph{}
С целью уменьшения дублирования данных и исключения аномалий введем
следующие объекты предметной области:

\begin{itemize}
\item <<награжденный>> --- хранит информацию о лице, предоставленным
  к государственной награде: ФИО, должность, пол, звание, место работы;
\item <<документ о награждении>> --- хранит информацию о документах,
  в которых перечислены списки лиц, предоставленных к награде: номер документа,
  название, дату принятия.
\end{itemize}

Объект <<награжденный>> может быть связан с несколькими
объектами <<факт награждения>> и каждый объект <<факт награждения>> 
соответствует единственному объекту <<награжденный>>.
Каждому объекту <<документ о награждении>> может соответствовать несколько
объектов <<факт награждения>> и каждому объекту <<факт награждения>> 
соответстЫЦвует единственный объект типа <<документ о награждении>>.

Кроме этого, проектируемый сервис должен поддерживать возможность ведения
учетных записи администраторов сервиса.
Cведения об учетных записях администраторов разумно также
расположить в базе данных. Для этого введем новый объект <<учетная запись>>,
который будет должен хранить следующие данные:
имя пользователя, пароль (в зашифрованном виде), адрес электронной почты.

\paragraph{}
Окончательная ER-модель проектируемой базы данных с учетом
дополнительных объектов предметной области приведена
на рисунке~\ref{fig:er_final}.

\begin{figure}[h]
  \centering
  \includegraphics[width=130mm]{pic/er_final.png}
  \caption{Окончательная ER-модель \\ проектируемой базы данных}
  \label{fig:er_final}
\end{figure}

Нетрудно убедиться,
что хранение данных в соответствии с модифицированной моделью не имеет
недостатков, перечисленных ранее.

Таким образом, в ходе инфологического проектирования были описаны основные
сценарии использования базы данных, формат и содержания входных и выходных файлов
объекты предметной области и связи между ними, разработана ER-модель, лишенная
ранее упомянутых недостатков дублирования данных и аномалий.

\subsection{Даталогическое проектирование}
\label{ssub:db_data_stage}

\paragraph{}
Приведем несколько определений, которые потребуются для описания процесса
даталогического проектирования, взятых из авторитетного источника~\cite{date05}.

\textit{Модель данных} --- это абстрактное, самодостаточное,
логическое определение объектов, операторов и прочих элементов,
в совокупности составляющих абстрактную  машину доступа к данным,
с которой взаимодействует пользователь.

Реляционная модель данных состоит из трех частей:
\begin{itemize}
\item
  \textit{структурная часть} описывает, какие объекты рассматриваются
  реляционной моделью.
  Единственной структурой данных, используемой в реляционной модели,
  являются \textit{нормализованные отношения}.
\item
  \textit{целостная часть} описывает ограничения специального вида,
  которые должны выполняться для любых отношений в любых реляционных базах данных.
  Это \textit{целостность сущностей} и \textit{целостность внешних ключей}.
\item
  \textit{манипуляционная часть} описывает два эквивалентных способа
  манипулирования реляционными данными --- \textit{реляционную алгебру} и
  \textit{реляционное исчисление}.
\end{itemize}

\textit{Нормализацией отношений} базы данных называется процесс приведения каждого отношения
(таблицы) этой базы данных к определенной нормальной форме.
Нормализация каждого отношения выполняется поэтапно:
сначала отношение приводится к первой нормальной форме, затем --- ко второй, и~т.~д.
При переходе к каждой последующей нормальной форме устраняются недостатки
(\textit{аномалии}), присущие предыдущей нормальной форме.

Приведем формальные определения первых трех нормальных форм, 
взятые из источника~\cite{date05}. 

Переменная отношения находится в \textit{первой нормальной форме} тогда
и только тогда, когда в любом допустимом значении этой переменной отношения каждый
ее кортеж содержит только одно значение для каждого из атрибутов.

Переменная отношения находится во \textit{второй нормальной форме} тогда и только тогда,
когда она находится в первой нормальной форме и каждый неключевой атрибут
неприводимо зависит от ее первичного ключа.

Переменная отношения находится в \textit{третьей нормальной форме} тогда и только тогда,
когда она находится во второй нормальной форме и ни один неключевой атрибут не является
транзитивно зависимым от ее первичного ключа.

Следует отметить, что существуют нормальные формы более высоких порядков,
но они редко используются в практических целях.  

\paragraph{}
Результатом даталогического проектирования является \textit{схема базы данных},
рассчитанная на конкретную СУБД, и удовлетворяющая следующим требованиям:
\begin{itemize}
  \item минимальная избыточность хранимых данных;
  \item минимальный физический объем данных;
  \item минимальное время доступа к данным;
  \item сокращение риска потери или искажения данных про внесении изменений
    в базу данных.
\end{itemize}

Для того, чтобы удовлетворить приведенные выше требования, достаточно проверить факт
нахождения отношений базы данных в определенной (как минимум, третьей) нормальной форме.
В том случае, когда отношение не отвечает требованиям определенной нормальной формы,
необходимо провести процедуру нормализации переменной отношения.

\paragraph{}
На основании ER-модели, разработанной в подразделе~\ref{ssub:db_info_stage}, 
построим даталогическую модель базы данных.
Каждому объекту на рисунке~\ref{fig:er_final} соответствует отдельное отношение
проектируемой базы данных. 

Схема даталогической модели проектируемой базы данных, разработанная в среде проектирования CA ERWin, 
показана на рисунке~\ref{fig:er_physical}.

\begin{figure}[h]
  \centering
  \includegraphics[width=150mm]{pic/er_physical.png}
  \caption{Даталогическая модель проектируемой базы данных}
  \label{fig:er_physical}
\end{figure}

\paragraph{}
Объекту <<документ о награждении>> соответствует отношение \textit{<<rewards\_documents>>},
схема которого приведена в таблице~\ref{tbl:rewards_documents_scheme}.

\begin{table}[h!]
  \caption{Схема отношения \textit{<<rewards\_documents>>}}
  \label{tbl:rewards_documents_scheme}
  \small{
    \centering
    \begin{tabular}{| p{0.3\textwidth} | p{0.25\textwidth} | p{0.2\textwidth} | p{0.14\textwidth} |}
      \hline
      Название атрибута \newline в модели &
      Название атрибута \newline в отношении &
      Тип хранимых \newline значений &
      Примечания \\ \hline

      Номер документа \newline о награждении &
      document\_number &
      INTEGER & Первичный ключ \\
      \hline

      Название документа &
      document\_title &
      VARCHAR(255) & \\
      \hline

      Дата принятия документа &
      document\_date &
      DATE & \\
      \hline

    \end{tabular}
  }
\end{table}

<<Номер документа о награждении>> принимает только целочисленные значения, следовательно, его следует хранить как целое число.

Покажем, что отношение \textit{<<rewards\_documents>>} находится в
третьей нормальной форме:
\begin{itemize}
\item
все атрибуты отношения принимают простые значения
(условие первой нормальной формы);
\item
все неключевые атрибуты зависят от простого ключа
(условие второй нормальной формы);
\item
в отношении нет ни одной транзитивной функциональной зависимости 
от потенциального ключа (условие третьей нормальной формы).
\end{itemize}

\paragraph{}
Объекту <<учетная запись>> соответствует отношение \textit{<<users>>},
схема которого приведена в таблице~\ref{tbl:users_scheme}.

\begin{table}[h!]
  \caption{Схема отношения \textit{<<users>>}}
  \label{tbl:users_scheme}
  \small{
    \centering
    \begin{tabular}{| p{0.25\textwidth} | p{0.23\textwidth} | p{0.18\textwidth} | p{0.24\textwidth} |}
      \hline
      Название атрибута \newline в модели &
      Название атрибута \newline в отношении &
      Тип хранимых \newline значений &
      Примечания \\ \hline

      Имя пользователя &
      user\_login &
      VARCHAR(255) &
      Первичный ключ \\
      \hline

      Пароль &
      user\_pass &
      VARCHAR(255) & \\
      \hline

      E-mail &
      user\_email &
      VARCHAR(255) & \\
      \hline
    \end{tabular}
  }
\end{table}

Значения атрибута <<имя пользователя>> является уникальным, 
поэтому этот атрибут можно использовать в качестве первичного ключа.
Значения атрибута <<пароль>> представляет собой результат применения определенной хэш-функции
к строке пароля, вводимого пользователем.

Нетрудно убедиться, что отношение \textit{<<users>>} находится в третьей
нормальной форме.

\paragraph{}
Объекту <<награда>> соответствует отношение \textit{<<awards>>},
схема которого приведена в таблице~\ref{tbl:awards_scheme}.

\begin{table}[h!]
  \caption{Схема отношения \textit{<<awards>>}}
  \label{tbl:awards_scheme}
  \small{
    \centering
    \begin{tabular}{| p{0.27\textwidth} | p{0.23\textwidth} | p{0.19\textwidth} | p{0.2\textwidth} |}
      \hline
      Название атрибута \newline в модели &
      Название атрибута \newline в отношении &
      Тип хранимых \newline значений &
      Примечания \\ \hline

      Название награды &
      award\_title &
      VARCHAR(255) &
      первичный ключ \\
      \hline

      Тип награды &
      award\_type &
      VARCHAR(20) & \\
      \hline

      Описание награды &
      award\_description &
      VARCHAR(255) & \\
      \hline

      Изображение награды &
      award\_image\_path &
      VARCHAR(255) & \\
      \hline
    \end{tabular}
  }
\end{table}

<<Название награды>> является уникальным, поэтому его можно использовать
в качестве первичного ключа.
<<Тип награды>> может принимать короткие строковые значения
из заданного списка.
<<Изображение награды>> представляет собой системный путь к изображению награды.

Нетрудно убедиться, что отношение \textit{<<awards>>} находится 
в третьей нормальной форме.

\paragraph{}
Объекту <<награжденный>> соответствует отношение \textit{<<awarded>>},
схема которого приведена в таблице~\ref{tbl:awarded_scheme}.

\begin{table}[h!]


  \caption{Схема отношения \textit{<<awarded>>}}
  \label{tbl:awarded_scheme}
  \small{
    \centering
    \begin{tabular}{| p{0.23\textwidth} | p{0.25\textwidth} | p{0.2\textwidth} | p{0.23\textwidth} |}
      \hline
      Название атрибута \newline в модели &
      Название атрибута \newline в отношении &
      Тип хранимых \newline значений &
      Примечания \\ \hline

      ID награжденного &
      awarded\_id &
      INTEGER &
      первичный ключ \\
      \hline

      ФИО награжденного &
      awarded\_name &
      VARCHAR(255) & \\
      \hline

      Пол награжденного &
      awarded\_sex &
      CHAR &
      принимает значения 'm' или 'w' \\
      \hline

      Место работы \newline награжденного &
      awarded\_job &
      VARCHAR(255) & \\
      \hline

      Должность \newline награжденного &
      awarded\_post &
      VARCHAR(255) & \\
      \hline

      Звание \newline награжденного &
      awarded\_rank &
      VARCHAR(255) & \\
      \hline

    \end{tabular}
  }
\end{table}

<<ID награжденного>> является первичным ключом и имеет целочисленный тип.
<<ФИО награжденного>> является строкой и может иметь значительную длину.
<<Пол награжденного>> представляет собой символ, определяющий пол.
<<Должность награжденного>> является строкой и может иметь значительную длину.
<<Звание награжденного>> и <<место работы награжденного>> представляют собой строки переменной длины.

Нетрудно убедиться, что отношение \textit{<<awards>>} находится в третьей
нормальной форме.

\paragraph{}
Объекту <<факт награждения>> соответствует отношение \textit{<<fact\_rewards>>},
схема которого приведена в таблице~\ref{tbl:fact_rewards_scheme}.

\begin{table}[h!]
  \caption{Схема отношения \textit{<<fact\_rewards>>}}
  \label{tbl:fact_rewards_scheme}
  \small{
    \centering
    \begin{tabular}{| p{0.25\textwidth} | p{0.23\textwidth} | p{0.18\textwidth} | p{0.24\textwidth} |}
      \hline
      Название атрибута \newline в модели &
      Название атрибута \newline в отношении &
      Тип хранимых \newline значений &
      Примечания \\ \hline

      Номер документа \newline о награждении &
      document\_number &
      INTEGER &
      входит в первичный ключ \\
      \hline

      Название награды &
      award\_title &
      VARCHAR(255) &
      входит в первичный ключ \\
      \hline

      ID награжденного &
      awarded\_id &
      INTEGER &
      входит в первичный ключ \\
      \hline

      Основание \newline для награждения &
      awarded\_basis &
      VARCHAR(255) & \\
      \hline

      Регистрационный \newline номер награды &
      reward\_number &
      VARCHAR(20) & \\
      \hline

    \end{tabular}
  }
\end{table}

Атрибуты <<номер документа о награждении>>, <<название награды>>,
<<ID награжденного>> являются внешними ключами и входят в составной 
первичный ключ.
<<Основание для награждения>> является строкой переменной длины.
<<Регистрационный номер награды>> имеет строковый тип и принимает значения вида
<<1/13962>>, корректность которых проверяется регулярным выражением.

Покажем, что отношение \textit{<<fact\_rewards>>} находится в третьей нормальной форме:
\begin{itemize}
\item
  все атрибуты отношения принимают простые значения
  (требование первой нормальной формы);
\item
  все неключевые атрибуты зависят от простого ключа
  (требование второй нормальной формы); 
\item
  в отношении нет ни одной транзитивной функциональной зависимости
  от потенциального ключа (требование третьей нормальной формы).
\end{itemize}

\paragraph{}
Таким образом, в ходе даталогического проектирования на основании ER-модели была разработана схема 
отношений базы данных.
Исходя из того, что все отношения проектируемой базы данных находятся в третьей нормальной форме,
можно утверждать, что вся база данных находится в третьей нормальной форме.

\paragraph{}
На этапе физического проектирования производится перенос разработанной
даталогической модели
на выбранное аппаратное и программное обеспечение.
Таким образом, результат данного этапа проектирования зависит от
выбранной целевой платформы.

Команды языка SQL, использованный для создания конфигупации таблиц,
соответствующей разработанной даталогической модели, 
приведены в приложении А.
