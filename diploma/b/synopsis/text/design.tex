\section[Проектирование программного модуля]{%
  ПРОЕКТИРОВАНИЕ ПРОГРАММНОГО МОДУЛЯ
}\label{sec:design}

\subsection{Общая характеристика задачи}

Проектирование является неотъемлемой частью жизненного цикла
разработки программного обеспечения.
Существует множество различных методологий проектирования.
Каждая из них предполагает описание требований к разрабатываемой системе
и разработку структуры системы, которая им удовлетворяет.
Как правило, в ходе проектирования требования к системе
многократно уточняются и дополняются.
Характер процесса проектирования определятся используемой
методологией разработки программного обеспечения.
Существует две основные методологии разработки ПО:
каскадная и итеративная, представленные на рисунке~\ref{fig:design_methods}.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=90mm]{fig/design_methods.eps}
  }
  \caption{Методологии разработки \\ программного обеспечения}
  \label{fig:design_methods}
\end{figure}

Каскадная методология разработки программного обеспечения сводится
к последовательному прохождению набора фаз разработки:
анализа требований, проектирования, реализации, тестирования, интеграции и поддержки.
При использовании данной методологии проектирование производится
лишь один раз. Входными данными являются требования к продукту,
а результатом --- набор технических документов, детально описывающих
различные аспекты работы разрабатываемой системы.
Дальнейшие этапы разработки производятся в строгом соответствии с этими документами;
изменение их содержания на последующих этапах нежелательно.

Итеративная методология рассматривает процесс разработки ПО как
циклическое прохождение описанных выше фаз.
Это позволяет команде разработчиков более динамично реагировать
как на внутренние, так и на внешние изменения требований к объекту разработки.
При использовании данной методологии проектирование производится множество раз.
На первых порах разрабатывается высокоуровневая архитектура системы,
определяются ключевые требования к ней. Далее, по мере повторения цикла
разработки, производится описание разрабатываемых подсистем и связей между ними.

Данный проект разрабатывается с использованием итеративной методологии:
сначала выполняется высокоуровневое описание частей проекта,
а затем по мере реализации уточняются детали функционирования его подсистем.
Проектирование выполняется с использованием языка графического
моделирования UML~\cite{fowler04}, а также набора документированных решений,
известных как паттерны проектирования GoF~\cite{gamma01}.

Объектом проектирования является мобильное приложение,
которое представляет собой самостоятельный программный модуль.
Поскольку необходимость интеграции в какую-либо существующую
систему отсутствует, задача проектирования значительно упрощается.
С другой стороны, целевая мобильная платформа выдвигает ряд дополнительных
требований:
\begin{itemize}
\item более строгие ограничения на используемые ресурсы;
\item необходимость учета разнообразия конфигураций мобильных устройств;
\item поддержка совместимости между различными версиями
  мобильной платформы.
\end{itemize}

Мобильные устройства располагают меньшими вычислительными
ресурсами по сравнению с персональными компьютерами.
Кроме этого, при разработке приложения
требуется учитывать его влияние на энергопотребление
целевого мобильного устройства.
Размер и плотность дисплеев мобильных устройств изменяются в широких пределах,
что влияет на качество отображения информации, предоставляемой приложением.
Программные интерфейсы различных версий мобильной платформы
могут быть несовместимы между собой.

Объектом проектирования является мобильное приложение,
выполняющее учет финансовых данных. По большому счету, пользователь
ожидает от него выполнения двух основных функций:
ввода финансовых данных и представления статистики на основе этих данных,
как показано на рисунке~\ref{fig:design_use_cases}.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=90mm]{fig/design_use_cases.eps}
  }
  \caption{Диаграмма прецендентов \\ использования приложения}
  \label{fig:design_use_cases}
\end{figure}

В нашем случае основную важность имеет не столько богатство
функциональности приложения, сколько удобство его повседневного использования.
В связи с этим на первый план выходят такие требования, как
высокая скорость ввода данных и наглядность их представления.
Скорость ввода данных достигается в первую очередь за счет
продуманного интерфейса приложения ---
ввод данных должен требовать заполнения минимально числа полей;
интерфейс ввода должен быть как можно более простым.
Наглядность представления данных достигается за счет надлежащей
структуризации данных и использования визуальных средств представления.
Поскольку приложение выполняет хранение данных, возникает необходимость
разработки модели данных и использовании СУБД.
Кроме этого, для реализации функции ввода данных с
фотокамеры мобильного устройства
требуется разработать отдельную подсистему.

\subsection{Структура разрабатываемого модуля}
\label{subsec:design_structure}

Одной из главных проблем, возникающей при разработке программного обеспечения,
является проблема управления сложностью. Зачастую моделируемые объекты реального
мира и механизмы их взаимодействия являются чересчур сложными для восприятия человека.
Дополнительную сложность вносят детали программной
реализации, которые, как правило, существенно отличаются
от сущности предмета моделирования.

Основным средством борьбы со сложностью при разработке программного обеспечения
на данным момент можно считать объектно-ориентированный подход.
Этот подход вводит понятие объекта как базового элемента
архитектуры системы, а также широко использует понтяие абстракциии для
разбиения проектируемой системы на логические уровни.
Модели, полученные с использованием данного подхода, весьма точно
описывают предметную область и являются сравнительно простыми для понимания.

В ходе практики использования объектно-ориентированного подхода
был разработан набор полезных <<рецептов>>,
позволяющих решать некоторые типичные проблемы проектирования.
Данные <<рецепты>>, называемые паттернами проектирования,
описывают различные механизмы создания, структуризации и взаимодействия объектов.

Паттерны проектирования особенно часто используются при разработке
библиотек и фреймворков.
Библиотеки представляют собой наборы структур данных и
связанных с ними алгоритмов для решения задач определенного класса,
например, ввод/вывод данных, рисование изображений, тестирование, и~т.~д.
Фреймворки представляют собой типовые программные решения
типичных задач проектирования.
В отличие от библиотек, фреймворки определяют структуру приложения в целом,
предоставляя разработчикам возможность переопределения
части программного кода своих компонентов.

Разработка приложения для мобильной платформы Android предполагает использование
объектно-ориентированного подхода. Несмотря на то, что в общем случае
платформа не предписывает использования какого-либо фреймворка,
ее программный интерфейс накладывает существенные ограничения на
архитектуру приложения.
Поскольку разрабатываемое приложение имеет графический интерфейс,
имеет смысл выполнять его проектирование на базе паттернов
разработки приложений с графическим интерфейсом.
Примером одного из них является MVP (Model-View-Presenter),
представленный на рисунке~\ref{fig:design_mvp}.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=90mm]{fig/design_mvp.eps}
  }
  \caption{Паттерн проектирования MVP}
  \label{fig:design_mvp}
\end{figure}

Основной идеей данного паттерна является разделение объектов приложения на три типа.
Объекты типа Model инкапсулируют собой ресурсы, предоставляемые приложению.
Объекты типа View занимаются представлением данных, определяя
детали представления данных пользователю.
Взаимодействие этих объектов производится через объекты типа Presenter,
определяющих логику обработки данных.
В этом заключается основное отличие данного паттерна
от его предшественников.
На рисунке~\ref{fig:design_main} представлена структура проектируемого приложения.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=140mm]{fig/design_main.eps}
  }
  \caption{Структура приложения}
  \label{fig:design_main}
\end{figure}

Здесь Model соответствуют подсистемам хранения данных и компьютерного зрения;
Presenter --- подсистеме обработки данных, а View ---
пользовательскому интерфейсу приложения.
Как и предписывается паттерном MVP, подсистемы пользовательского интерфейса,
хранения данных и компьютерного зрения изолированы друг от друга и взаимодействуют
между собой через подсистему обработки данных.

Рассмотрим организацию пользовательского интерфейса более подробно.
Пользовательский интерфейс приложений для платформы Android состоит
из так называемых экранов.
Экран по сути соответствует окну оконного менеджера графической оболочки
операционной системы. Их основное отличие заключается в том,
что экраны мобильного приложения не могут перекрываться,
т.~е. экран занимает все пространство дисплея
мобильного устройства.
Как правило, каждый экран приложения предназначен
для выполнения какой-либо одной функции.
На рисунке~\ref{fig:design_activities} представлена схема экранов приложения
и переходов между ними.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=130mm]{fig/design_activities.eps}
  }
  \caption{Схема экранов приложения}
  \label{fig:design_activities}
\end{figure}

Приложение состоит из шести экранов; переходы между ними показаны стрелками.
Экран просмотра статистики учетных записей является главным экраном приложения
и предназначен для отображения информации об учетных записях пользователя,
а также списка изменений состояния баланса.
Экраны редактирования изменений баланса, учетных записей и категорий
используются для добавления и изменения выбранного изменения баланса,
учетной записи и категории соответственно.
Экраны просмотра списков учетных записей и категорий учета используются
для просмотра и удаления учетных записей и категорий.
Более подробное рассмотрение содержимого данных экранов находится
в подразделе~\ref{subsec:implementation_ui}.

\subsection{Информационное обеспечение}
\label{subsec:design_information}

Описание информационного обеспечения любого программного продукта сводится
к описанию форматов входных и выходных данных, а также модели хранения
этих данных.
Разрабатываемое приложение оперирует достаточно простым набором сущностей
предметной области: <<Изменение баланса>>, <<Учетная запись>> и <<КатегорияУчета>>.
Сущность <<Изменение баланса>> используется для регистрации изменений
финансового состояния пользователя и соответствует единичной транзакции
денежных средств.
Примерами подобной сущности могут являться получение заработной платы,
расход денежных средств на замену автомобильной резины или на поход в
парикмахерскую.
Сущность <<Учетная запись>> соответствует средству хранения денежных
средств, например, банковской карте или наличным.
Сущность <<Категория учета>> используется для группировки изменений баланса
по статьям доходов или расходов. Примерами экземпляров данной сущности
могут являться <<заработная плата>>, <<продукты>>, <<транспорт>>,~и~т.~д.
На рисунке~\ref{fig:design_entities} представлена модель данных
разрабатываемого приложения.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=140mm]{fig/design_entities.eps}
  }
  \caption{Модель данных приложения}
  \label{fig:design_entities}
\end{figure}

В соответствии с ней, сущность <<УчетнаяЗапись>> имеет поле названия,
являющееся ключевым, поле кода валюты, хранящее стандартизированное значение
кода валюты в соответствии со стандартом ISO 4217,
а также ссылку на множество сущностей <<ИзменениеБаланса>>.
Данные сущности имеют служебное поле <<Индекс>>,
являющееся ключевым, поле даты регистрации, величины изменения баланса,
а также ссылку на множество связанных категорий учета.
Сущность <<КатегорияУчета>> имеет ключевое поле названия, а также поле типа,
определяющее, относится ли данная категория к доходам или расходам.

Определенный интерес представляет вопрос выбора типа данных для хранения
значения изменения баланса. Дело в том, что для хранения финансовых данных
использовать дробные типы данных не рекомендуется
из-за ошибок округления~\cite{bloch08}. С другой стороны, не все СУБД
поддерживают специализированный тип данных для работы с валютой.
В связи с этим для хранения финансовой информации используется целочисленное
поле двойной длины (\textit{long}), младшие девять разрядов которого используются
для хранения дробной, а старшие --- для хранения целой части
исходной величины.

Ввод данных в приложение носит преимущественно ручной характер:
например, при вводе данных об изменении баланса
пользователь приложения должен ввести величину изменения баланса,
выбрать желаемые категории и указать дату.
Использование экспериментальной подсистемы компьютерного зрения
позволяет вводить данные о величине изменения баланса в
автоматическом режиме.

Вывод данных производится в текстовом и графическом виде и
представляет как собственно хранимые данные, так и данные, полученные путем
применения агрегатных функций. Например, практический интерес представляют
суммы изменений баланса за указанный период, а также распределение
данных сумм по различным категориям учета.

\subsection{Алгоритмическое обеспечение}
\label{ssec:design_algorithm}

Рассмотрим вопросы проектирования алгоритма оптического
распознавания числовых данных, используемого в разрабатываемом приложении.
Опишем типичные проблемы, возникающие при разработке алгоритмов подобного рода
для мобильных устройств:
\begin{enumerate}
  \item Проблема ограниченности ресурсов вычислительной среды.
    К сожалению, мобильные устройства обладают сравнительно малой вычислительной
    мощностью а также объемом оперативной памяти.
    Это накладывает жесткие ограничения на вычислительную сложность
    разрабатываемых алгоритмов, а также на размер используемой модели распознавания.
  \item Проблема корректного выделения зон интереса.
    Алгоритм должен выделять максимально возможное число зон интереса
    при минимальном числе ложных срабатываний.
  \item Проблемы технического характера. Сюда входят проблемы выбора исходных данных для
    обучения алгоритма, вопросы лицензирования используемых алгоритмов~и~т.~п.
\end{enumerate}

Руководствуясь весьма общими представлениями, можно сделать вывод,
что проектируемый алгоритм должен состоять из последовательности этапов,
представленной на рисунке~\ref{fig:design_algorithm_basic}.
Алгоритм имеет линейную структуру; входными данными для него является изображение,
полученное с фотокамеры мобильного устройства, а выходными --- набор цифр,
являющихся результатами распознавания.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=90mm]{fig/design_algorithm_basic.eps}
  }
  \caption{Схема алгоритма \\ оптического распознавания данных}
  \label{fig:design_algorithm_basic}
\end{figure}

Основной интерес представляет содержание этапов проектируемого алгоритма.
На этапе первичной обработки изображения производятся
регулировка яркости и контрастности изображения,
устранение шумов путем размытия и бинаризация.
На этапе выделения зон интереса производится выделение частей изображения,
представляющих собой числовые данные на основании данных
о контурах изображения, получаемых с помощью алгоритма, описанного в~\cite{suzuki85}.
Этап распознавания данных в зонах интереса является составным;
схема его представлена на рисунке~\ref{fig:design_algorithm_recognition}.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=90mm]{fig/design_algorithm_recognition.eps}
  }
  \caption{Схема алгоритма распознавания \\ данных в зоне интереса}
  \label{fig:design_algorithm_recognition}
\end{figure}

Рассмотрим более подробно вопросы выбора дескрипторов
для кодирования зон интереса, а также алгоритма их классификации.
В простейшем случае дескриптор изображения представляет собой вектор
вещественных значений, описывающий исходное изображение и обладающий
специальными свойствами:
устойчивостью к изменению характера освещения исходного изображения,
инвариантностью к его поворотам, линейным трансформациям и.~т.~п.
В нашем случае необходимость использования дескрипторов зон интереса
вызвана в первую очередь требованием обеспечения компактности модели распознавания,
при этом множеству классов дескрипторов соответствует множество арабских цифр,
являющихся результатом распознавания.

В литературе описано множество различных дескрипторов:
SIFT~\cite{lowe04},
SURF~\cite{bay08},
BRIEF~\cite{calonder10},
BRISK~\cite{leutenegger11},
FREAK~\cite{ortiz12},
HOG~\cite{dalal05} и т.~д.
Следует отметить, что SIFT и SURF являются запатентованными,
их использование в коммерческих целях является платным.
Дескрипторы BRIEF и FREAK используют в качестве входных данных координаты
ключевых точек зоны интереса, получаемые специализированным алгоритмами
поиска ключевых точек, например, SIFT или ORB.
Использование данных алгоритмов имеет два недостатка.
Во-первых, они имеют высокую вычислительную сложность.
Во-вторых, множество ключевых точек, получаесмых с их помощью,
является в общем случае неустойчивым, что негативно отражается
на точности распознавания.
С другой стороны, HOG-дескриптор не требует предоставления множества
ключевых точек, что делает его предпочтительным.
Приведем краткое описание этапов алгоритма вычисления HOG-дескриптора:
\begin{enumerate}
\item Исходное изображение разбивается на множество ячеек прямоугольной формы.
  Производится расчет значений градиентов в каждой точке изображения.
\item Вычисляются гистограммы ячеек. Каждая точка ячейки участвует
  во взвешенном голосовании для каналов гистограммы направлений, основанном
  на значении градиентов.
\item Для учета изменений яркости и контрастности ячеек производится локальная
  нормировка градиентов на основании групп ячеек, называемых блоками.
\end{enumerate}

Основными параметрами данного алгоритма являются размер ячейки,
размер и форма блоков, функция нормировки градиентов. Изменение
данных параметров существенно влияет на качество распознавания,
а также на размер получаемых дескрипторов.

Существует множество алгоритмов машинного обучения,
предназначенных для классификации образов.
Среди них можно выделить
KNN~\cite{cover67}, SVM~\cite{vapnik74}, CNN~\cite{lecun98}.
В ходе исследования литературы было обнаружено, что
для реализации алгоритма оптического распознавания данных
на мобильном устройстве предпочтительнее всего использовать SVM,
поскольку он имеет малый размер модели распознавания по сравнению с KNN
и высокую скорость работы по сравнению с CNN.

Вкратце, суть SVM сводится к разделению входных данных,
представленняемых в виде точек в \( p \)-мерном пространстве,
на классы путем построения набора оптимальных гиперплоскостей.
Оптимальной гиперплоскостью называется такая гиперплоскость,
расстояние между двумя ближайшими точками по разные стороны от которой
является максимальным.
Пример оптимальной плоскости в двумерном пространстве приведен
на рисунке~\ref{fig:design_algorithm_svm}.
Показано, что задача построения оптимальной гиперплоскости можно свести
к задаче квадратичной оптимизации.
В случае линейной неразделимости входных данных их разделение
можно осуществлять за счет нелинейного отображения исходных данных
на пространство классификации~\cite{boser92}.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=90mm]{fig/design_algorithm_svm.png}
  }
  \caption{Оптимальная плоскость разделения \\ различных классов данных}
  \label{fig:design_algorithm_svm}
\end{figure}

В разрабатываемом алгоритме оптического распознавания данных
используется алгоритм классификации SVM совместно с
использованием HOG-дескрипторов.
Данный подход, описанный в~\cite{ebrahimzadeh14},
позволяет получить высокую точность распознавания при
сравнительно скромных требованиях к вычислительным ресурсам.

Для обучения модели распознавания используется открытая база рукописных
цифр для машииного обучения MNIST~\cite{mnist}.
Она представляет собой крупный (около 70000 изображений) набор данных
для обучения и оценки качества моделей распознавания рукописных цифр,
представленный в стандартизированной форме.

\subsection{Системные требования}

Разрабатываемое приложение предназначено для работы на мобильных устройствах
под управлением операционной системы Android версии не ниже 4.0.x (android-15).
Целевое устройство должно иметь ARM-совместимый процессор с тактовой частотой не менее
1 ГГц и располагать оперативной памятью объемом не менее 128 MБ.
Для полноценной работы приложения требуется наличие фотокамеры,
расположенной на тыльной стороне устройства.

\subsection{Эргономическое обеспечение}

В течение достаточно долгого времени внешний вид пользовательского интерфейса
приложений под управлением платформы Android не был регламентирован:
внешний вид, размещение и шаблоны взаимодействия различных элементов управления
были отданы на откуп разработчикам приложений.
Как следствие, внешний вид различных приложений мог заметно различаться.
Эта особенность представляла собой существенный недостаток платформы
с точки зрения пользователя.
В 2014 году компания Google представила сообществу Material Design ---
свод рекомендаций по оформлению элементов пользовательского интерфейса
мобильных приложений. Вместе с публикацией этих рекомендаций был
разработан набор библиотек, позволяющих реализовать их на предыдущих версиях платформы.
Данный свод рекомендаций находится в открытом доступе~\cite{material_design}.
В настоящее время подавляющее большинство мобильных приложений для
платформы Android разрабатывается в соответствии с ним.

Material design вводит ключевое понятие материала в контексте
пользовательского интерфейса приложения и рассматривает следующие
вопросы его использования:
\begin{itemize}
\item эффективная организация пользовательского интерфейса;
\item использование наборов цветов, иконок и шрифтов;
\item использование теней и отступов,
  а также анимации для переходов между различными состояниями.
\end{itemize}

Кроме этого, в нем приводится множество практических примеров
организации пользоваительского интерфейса.
На рисунке~\ref{fig:design_colors} представлена цветовая палитра
приложения, разработанная в соответствии с Material Design.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=140mm]{fig/design_colors.eps}
  }
  \caption{Используемая цветовая палитра}
  \label{fig:design_colors}
\end{figure}

Цвета <<индиго>> и <<темно-голубой>>
используются в качестве основных элементов интерфейса:
панели навигации, панелей выбора вкладок.
Салатовый цвет используется для подсвечивания выбранных вкладок,
а также выделения активных полей ввода.
Вспомогательные цвета используются в качестве фоновых цветов списков,
а также для оформления текста.

Material design предписывает использование семейства шрифтов
Roboto Sans для отображения текста, состоящего из латинских
и кириллических символов. Кроме этого, он регламентирует
использование различных размеров и начертаний данного шрифта.
Правилом хорошего тона является использование не более трех
различных начертаний шрифта на одном экране.
На рисунке~\ref{fig:design_fonts} приведен набор начертаний,
используемых в приложении.

\begin{figure}[h!]
  \centering
  \fcolorbox{gray}{white}{
    \includegraphics[width=140mm]{fig/design_fonts.eps}
  }
  \caption{Используемый набор начертаний}
  \label{fig:design_fonts}
\end{figure}

Все они основаны на базовом начертании шрифта Roboto Sans.
Размер начертаний указан в scale-independent pixels, учитывающих различия
в размерах и плотности дисплеев различных целевых устройств,
а также параметров настройки операционной системы.
Шрифт размером в 34sp применяется для отображения в первую очередь
текущего состояния счетов пользователя;
размер в 20sp используется при заполнении обязательных полей при вводе данных;
размеры 14sp и 12sp --- для отображения основного и вспомогательного текста
соответственно.

Кроме этого, разрабатываемое приложение использует иконки для
наглядного представления доступных пользователю опций меню.
Все они являются векторными изображениями, источником для них
является стандартный репозиторий иконок Material Design.